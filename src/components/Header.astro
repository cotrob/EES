---
const navItems = [
  { href: '/', label: 'Home' },
  { href: '/about', label: 'About' },
  {
    label: 'Services',
    megaMenu: [
      {
        title: 'Residential',
        image: '/image/photography/Frontage_1.webp',
        href: '/services/residential',
        buttonText: 'See Examples',
        services: [
          { href: '/services/residential/solar-systems', label: 'Solar Systems' },
          { href: '/services/residential/comfort-conditioning', label: 'Comfort Conditioning' },
          { href: '/services/residential/battery-systems', label: 'Battery Systems' },
          { href: '/services/residential/heat-pump-systems', label: 'Heat Pump Systems' },
          { href: '/services/residential/home-automation', label: 'Home Automation' },
          { href: '/services/residential/hvac', label: 'HVAC' },
        ],
      },
      {
        title: 'Commercial',
        image: '/image/photography/Frontage_5.webp',
        href: '/services/commercial',
        buttonText: 'See Examples',
        services: [
          { href: '/services/commercial/solar-systems', label: 'Solar Systems' },
          { href: '/services/commercial/comfort-conditioning', label: 'Comfort Conditioning' },
          { href: '/services/commercial/battery-systems', label: 'Battery Systems' },
          { href: '/services/commercial/heat-pump-systems', label: 'Heat Pump Systems' },
          { href: '/services/commercial/home-automation', label: 'Home Automation' },
          { href: '/services/commercial/hvac', label: 'HVAC' },
        ],
      },
      {
        title: 'Resources',
        image: '/image/photography/Frontage_3.webp',
        href: '/resources',
        hideButton: true,
        services: [
          { href: '/services/consultation', label: 'Free Consultation' },
          { href: '/services/financing', label: 'Financing Options' },
          { href: '/services/faq', label: 'FAQs' },
        ],
      },
    ],
  },
  { divider: true },
  {
    label: 'Research',
    megaMenu: [
      {
        title: 'Facility',
        image: '/image/photography/Frontage_6.webp',
        href: '/laboratory/facility',
        services: [
          { href: '/laboratory/simulation-room', label: 'Simulation Room (Test Cell)' },
        ],
      },
      {
        title: 'Products',
        image: '/image/photography/Frontage_7.webp',
        href: '/laboratory/products',
        services: [
          { href: '/laboratory/hydronic-ceiling-panels', label: 'Hydronic Ceiling Panels' },
          { href: '/laboratory/environmental-service-pod', label: 'Environmental Service Pod' },
        ],
      },
      {
        title: 'Resources',
        href: '/laboratory/resources',
        hideButton: true,
        services: [
          { href: '/laboratory/written-papers', label: 'Written Papers' },
          { href: '/laboratory/footage', label: 'Footage' },
        ],
      },
    ],
  },
  { divider: true },
  // { href: '/case-studies', label: 'Case Studies' },
  // { href: '/blog', label: 'Blog' },
  { href: '/contact', label: 'Contact' },
];

const currentPath = Astro.url.pathname;
---

<header class="header" id="main-header">
  <nav class="nav">
    <a href="/" class="logo">
      <img src="/image/logo/logo_special_navVersion_White.svg" alt="EES Environmental Energy Services" class="logo-img" />
    </a>
    <ul class="nav-links">
      {navItems.map((item: any) => (
        item.divider ? (
          <li class="nav-divider" aria-hidden="true"></li>
        ) : (
        <li class:list={['nav-item', { 'has-mega': item.megaMenu }]}>
          {item.href ? (
            <a
              href={item.href}
              class:list={['nav-link', { active: currentPath === item.href }]}
            >
              {item.label}
            </a>
          ) : (
            <>
              <button class="nav-link nav-toggle" type="button">
                {item.label}
                <svg class="chevron" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="m6 9 6 6 6-6"/>
                </svg>
              </button>
              <div class="mega-menu">
                <div class="mega-menu-inner">
                  {item.megaMenu?.map((card: any) => (
                    <div class="mega-card">
                      <div class="mega-card-header">
                        <h3>{card.title}</h3>
                        {!card.hideButton && (
                          <a href={card.href} class="mega-learn-more">
                            {card.buttonText || 'Learn More'}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                          </a>
                        )}
                      </div>
                      <ul class="mega-card-links">
                        {card.services.map((svc: any) => (
                          <li>
                            <a href={svc.href}>
                              {svc.label}
                              <svg class="mega-link-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                            </a>
                          </li>
                        ))}
                      </ul>
                    </div>
                  ))}
                </div>
              </div>
            </>
          )}
        </li>
        )
      ))}
    </ul>
    <a href="#solar-qualifier" class="nav-cta"><svg class="cta-arrow" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="m19 12-7 7-7-7"/></svg>Get Your Free Quote</a>
    <button class="menu-toggle" id="menu-toggle" type="button">Menu</button>
  </nav>
</header>

<script>
  const header = document.getElementById('main-header');
  const menuToggle = document.getElementById('menu-toggle');

  function handleScroll() {
    const hero = document.querySelector('.hero') as HTMLElement | null;
    const threshold = hero ? hero.offsetHeight - 100 : 50;
    if (window.scrollY > threshold) {
      header?.classList.add('scrolled');
    } else {
      header?.classList.remove('scrolled');
    }
  }

  menuToggle?.addEventListener('click', () => {
    header?.classList.toggle('menu-open');
    const isOpen = header?.classList.contains('menu-open');
    menuToggle.textContent = isOpen ? 'Close' : 'Menu';
  });

  window.addEventListener('scroll', handleScroll, { passive: true });
  handleScroll();

  // Mega menu interactions
  const megaItems = document.querySelectorAll('.nav-item.has-mega');
  const megaTimers = new Map<Element, ReturnType<typeof setTimeout>>();
  const isMobile = () => window.innerWidth <= 900;

  // Mobile: click toggles on nav-toggle buttons
  document.querySelectorAll('.nav-toggle').forEach((btn) => {
    btn.addEventListener('click', (e) => {
      if (!isMobile()) return;
      e.preventDefault();
      const item = btn.closest('.nav-item.has-mega');
      if (!item) return;
      const wasOpen = item.classList.contains('mega-open');
      // Close all others
      megaItems.forEach((other) => other.classList.remove('mega-open'));
      if (!wasOpen) item.classList.add('mega-open');
    });
  });

  // Desktop: open on hover, close after delay on leave
  megaItems.forEach((item) => {
    item.addEventListener('mouseenter', () => {
      if (isMobile()) return;
      const timer = megaTimers.get(item);
      if (timer) { clearTimeout(timer); megaTimers.delete(item); }
      megaItems.forEach((other) => {
        if (other !== item) {
          other.classList.remove('mega-open');
          const t = megaTimers.get(other);
          if (t) { clearTimeout(t); megaTimers.delete(other); }
        }
      });
      item.classList.add('mega-open');
    });

    item.addEventListener('mouseleave', () => {
      if (isMobile()) return;
      const timer = setTimeout(() => {
        item.classList.remove('mega-open');
        megaTimers.delete(item);
      }, 2100);
      megaTimers.set(item, timer);
    });
  });

  // Close mega menu when clicking anywhere outside
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    megaItems.forEach((item) => {
      if (!item.contains(target)) {
        item.classList.remove('mega-open');
        const timer = megaTimers.get(item);
        if (timer) { clearTimeout(timer); megaTimers.delete(item); }
      }
    });
  });
</script>

<style>
  .header {
    position: fixed;
    top: 1.5rem;
    left: 50%;
    transform: translateX(-50%);
    width: calc(100% - 4rem);
    max-width: 1200px;
    z-index: 1000;
    padding: 0.875rem 2rem;
    border-radius: 9999px;
  }

  .header::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background: rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(16px) saturate(180%);
    -webkit-backdrop-filter: blur(16px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
    z-index: -1;
    transition: background 0.3s ease, box-shadow 0.3s ease, backdrop-filter 0.3s ease, border-color 0.3s ease;
  }

  .header.scrolled::before {
    background: rgba(14, 43, 71, 0.85);
    border-color: rgba(255, 255, 255, 0.15);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  }

  .nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  /* Nav logo - always visible */
  .logo {
    text-decoration: none;
    display: flex;
    align-items: center;
  }

  .logo-img {
    height: 1.75rem;
    width: auto;
  }

  .nav-links {
    display: flex;
    gap: 0.25rem;
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .nav-item {
    position: relative;
  }

  .nav-item.has-mega {
    position: static;
  }

  .nav-divider {
    width: 1px;
    height: 1.25rem;
    background: rgba(255, 255, 255, 0.3);
    align-self: center;
    margin: 0 0.25rem;
    list-style: none;
  }

  .nav-link {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.5rem 1rem;
    text-decoration: none;
    color: #fff;
    font-weight: 500;
    border-radius: 9999px;
    transition: background 0.2s, color 0.2s;
    background: none;
    border: none;
    font-size: 0.9375rem;
    cursor: pointer;
    white-space: nowrap;
  }

  .nav-link:hover,
  .nav-link.active {
    background: rgba(255, 255, 255, 0.15);
    color: #fff;
  }

  .nav-toggle .chevron {
    transition: transform 0.2s;
  }

  .nav-item.has-mega.mega-open .chevron {
    transform: rotate(180deg);
  }

  .nav-cta {
    padding: 0.625rem 1.5rem;
    background: #2061B7;
    color: #fff;
    text-decoration: none;
    border-radius: 9999px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    font-weight: 500;
    font-size: 0.9375rem;
    transition: background 0.2s, transform 0.2s;
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
  }

  .cta-arrow {
    flex-shrink: 0;
  }

  .cta-arrow {
    animation: arrowBounce 2.5s ease-in-out infinite;
  }

  .nav-cta:hover {
    background: #184A8B;
    color: #fff;
  }

  .nav-cta:hover .cta-arrow {
    animation: none;
  }

  @keyframes arrowBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(3px); }
  }

  /* Mega Menu */
  .mega-menu {
    position: absolute;
    top: calc(100% + 1rem);
    left: 50%;
    transform: translateX(-50%) translateY(10px);
    padding-top: 0.5rem;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.25s ease, transform 0.25s ease, visibility 0.25s;
    pointer-events: none;
  }

  .nav-item.has-mega.mega-open .mega-menu {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
    pointer-events: auto;
  }

  .mega-menu-inner {
    display: grid;
    grid-auto-columns: 1fr;
    grid-auto-flow: column;
    gap: 1rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(80px) saturate(180%);
    -webkit-backdrop-filter: blur(80px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 1.5rem;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
    transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease, backdrop-filter 0.3s ease;
  }

  .header.scrolled .mega-menu-inner {
    background: rgba(14, 43, 71, 0.85);
    backdrop-filter: blur(80px) saturate(180%);
    -webkit-backdrop-filter: blur(80px) saturate(180%);
    border-color: rgba(255, 255, 255, 0.15);
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
  }

  .mega-card {
    display: flex;
    flex-direction: column;
    border-radius: 0.75rem;
    padding: 1.25rem;
    min-width: 260px;
    background: linear-gradient(135deg, rgba(22, 53, 84, 0.6) 0%, rgba(14, 43, 71, 0.4) 100%);
    backdrop-filter: blur(12px) saturate(150%);
    -webkit-backdrop-filter: blur(12px) saturate(150%);
    border: 1px solid rgba(255, 255, 255, 0.12);
    box-shadow:
      inset 0 1px 0 rgba(255, 255, 255, 0.1),
      inset 0 0 20px rgba(255, 255, 255, 0.03),
      0 4px 16px rgba(0, 0, 0, 0.15);
    transition: background 0.3s, border-color 0.3s, box-shadow 0.3s;
    color: #fff;
    position: relative;
    overflow: hidden;
  }

  .mega-card::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(ellipse at 30% 20%, rgba(255, 255, 255, 0.06) 0%, transparent 50%);
    pointer-events: none;
  }

  .mega-card:hover {
    background: linear-gradient(135deg, rgba(27, 63, 99, 0.7) 0%, rgba(20, 55, 88, 0.5) 100%);
    border-color: rgba(255, 255, 255, 0.18);
    box-shadow:
      inset 0 1px 0 rgba(255, 255, 255, 0.15),
      inset 0 0 24px rgba(255, 255, 255, 0.05),
      0 8px 24px rgba(0, 0, 0, 0.2);
  }

  .mega-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.75rem;
    gap: 0.75rem;
  }

  .mega-card-header h3 {
    font-size: 1.0625rem;
    font-weight: 700;
    margin: 0;
    color: #fff;
    letter-spacing: 0.01em;
  }

  .mega-learn-more {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.3rem 0.75rem;
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.25);
    border-radius: 9999px;
    color: #fff;
    text-decoration: none;
    font-size: 0.75rem;
    font-weight: 500;
    white-space: nowrap;
    transition: background 0.2s;
  }

  .mega-learn-more:hover {
    background: rgba(255, 255, 255, 0.25);
    color: #fff;
  }

  .mega-card-links {
    list-style: none;
    padding: 0;
    margin: 0;
    padding-left: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
    border-left: 1px solid rgba(255, 255, 255, 0.15);
  }

  .mega-card-links a {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.3rem 0;
    color: rgba(255, 255, 255, 0.8);
    text-decoration: none;
    font-size: 0.875rem;
    transition: color 0.15s;
  }

  .mega-card-links a:hover {
    color: #fff;
  }

  .mega-link-chevron {
    opacity: 0.4;
    transition: opacity 0.15s, transform 0.15s;
    flex-shrink: 0;
  }

  .mega-card-links a:hover .mega-link-chevron {
    opacity: 1;
    transform: translateX(2px);
  }

  /* Menu toggle - hidden on desktop */
  .menu-toggle {
    display: none;
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.25);
    color: #fff;
    font-weight: 600;
    font-size: 0.875rem;
    padding: 0.5rem 1.25rem;
    border-radius: 9999px;
    cursor: pointer;
    letter-spacing: 0.03em;
    transition: background 0.2s;
  }

  .menu-toggle:hover {
    background: rgba(255, 255, 255, 0.25);
  }

  @media (max-width: 900px) {
    .header {
      left: 1rem;
      right: auto;
      width: calc(100vw - 2rem);
      max-width: none;
      transform: none;
      top: 1rem;
      border-radius: 9999px;
      padding: 0.75rem 1.25rem;
    }

    .nav-links,
    .nav-cta {
      display: none;
    }

    .logo-img {
      height: 1.5rem;
    }

    .menu-toggle {
      display: block;
    }

    /* Open state */
    .header.menu-open {
      border-radius: 1.5rem;
    }

    .header.menu-open::before {
      background: rgba(14, 43, 71, 0.85);
      border-color: rgba(255, 255, 255, 0.15);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    .header.menu-open .nav {
      flex-wrap: wrap;
    }

    .header.menu-open .nav-links {
      display: flex;
      flex-direction: column;
      width: 100%;
      gap: 0.25rem;
      padding: 1rem 0 0.5rem;
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      margin-top: 0.75rem;
    }

    .header.menu-open .nav-divider {
      display: none;
    }

    .header.menu-open .nav-cta {
      display: block;
      width: 100%;
      text-align: center;
      margin-top: 0.5rem;
      margin-bottom: 0.25rem;
    }

    .header.menu-open .nav-link {
      padding: 0.625rem 1rem;
      border-radius: 0.75rem;
    }

    /* Mega menu mobile - hidden by default, toggled via .mega-open */
    .header.menu-open .mega-menu {
      position: static;
      transform: none;
      padding-top: 0;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      max-height: 0;
      overflow: hidden;
      transition: opacity 0.25s ease, max-height 0.3s ease, visibility 0.25s;
    }

    .header.menu-open .nav-item.has-mega.mega-open .mega-menu {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
      max-height: 800px;
      transform: none;
    }

    /* Simple flat list on mobile - no cards */
    .header.menu-open .mega-menu-inner {
      display: flex;
      flex-direction: column;
      gap: 0;
      padding: 0.25rem 0;
      background: none;
      border: none;
      border-radius: 0;
      box-shadow: none;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }

    .header.menu-open .mega-card {
      background: none;
      border: none;
      box-shadow: none;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      padding: 0;
      border-radius: 0;
    }

    .header.menu-open .mega-card::before {
      display: none;
    }

    .header.menu-open .mega-card-header {
      margin-bottom: 0.25rem;
    }

    .header.menu-open .mega-card-header h3 {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(255, 255, 255, 0.45);
      font-weight: 500;
      margin-top: 0.75rem;
    }

    .header.menu-open .mega-learn-more {
      display: none;
    }

    .header.menu-open .mega-card-links {
      border-left: none;
      padding-left: 0;
      gap: 0;
    }

    .header.menu-open .mega-card-links a {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-size: 0.9375rem;
      color: rgba(255, 255, 255, 0.85);
    }

    .header.menu-open .mega-card-links a:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .header.menu-open .mega-link-chevron {
      display: none;
    }
  }
</style>
